\section{Android Instrumentation}
\label{sec-logging}

\input{./figures/logging/table.tex}

Android's logging mechanism provides a surprisingly powerful view of the
internals of platform operation. In addition, despite instructions
encouraging application developers to disable logging before release, many
developers either forget or ignore this advice. We have seen logs generated
on \PhoneLab{} with \num{7556} different log tags, indicating that
information about application behavior is also available.

Here we present several useful Android logging techniques suitable for use on
\PhoneLab{}. While we do plan on extending our data collection interface to
support arbitrary data generated by experiments, we believe that the logging
interface will prove a popular way to recover data. Particularly because
support for Android logging in Eclipse provides a seamless transition from
local experiment development to \PhoneLab{} distribution.

\subsection{Intent Monitoring}

Inter-process communication on Android occurs via \textit{intents}, which are
Android message objects. Because the Android platform uses broadcast intents
to distribute useful information to applications, they provide ideal logging
hooks. An experimental application can subscribe to intents that it is
interested in, and log information when they arrive.

Broadcast intents are sent when applications are installed or uninstalled,
the radio of WiFi signal strength changes, the phone rings and is answered,
and the battery level changes. Our usage experiment described in
Section~\ref{sec-experiment} subscribes to many of these useful intents to
and uses them to monitor device behavior.

\subsection{Log Snooping}

Experiment-driven logging of information obtained through intents may not be
sufficient to reveal all events of interest. In certain cases, however,
information that cannot be obtained and logged by an experiment is already
ending up in the Android logs via messages sent by another component. We
noticed during testing that many system components logged useful information,
and so received IRB approval to collect all logs tags generated by
participants phones---not only the ones generated by our usage experiment.
This also served as a useful stress test on the \PhoneLab{} backend
infrastructure.

Table~\ref{table-logtags} lists the top 20 tags from the over 700~million log
messages in our database. As the table demonstrates, many core Android
services already dump data, much of it useful, to the system log. Our usage
experiment also uses several of these tags to uncover information that would
normally be accessible, such as the screen state transitions.
Table~\ref{table-experimenttags} has more details.

To make log snooping more feasible and useful we are exploring the option of
improving logging coverage within the Android platform. Our experience with
our first experiment has indicated that some information is more difficult to
obtain than we would prefer, and other pieces of critical information are
entirely missing. For example, while the \texttt{ActivityManager} tags
indicate when applications are started, use of the back button by the
participant is not logged. This makes it impossible to determine what
application is currently in the foreground at a fine granularity.

With access to the platform source, we can improve the visibility of
important usage information. Another benefit of this approach is that
experimenters will not have to incorporate common code for logging standard
Android information into their experimental applications. Instead, they will
simply request the appropriate tag be added to their log archive.

\subsection{Java Reflection}

The third monitoring technique is to use Java reflection to access hidden APIs
of Android. Typically, this is not a recommended practice because hidden APIs
can change any time and break the application that uses them. However, if used
carefully, it can be a useful tool to collect information not available
otherwise. Battery statistics is a good example because there is no public
Android API that gives access to the information. However, this information is
still available through hidden APIs that Android's Settings application uses to
display battery statistics. Using Java reflection, any application can access
these APIs. In fact, our experiment uses this method to access battery
statistics as we describe in Section~\ref{sec-experiment}.
